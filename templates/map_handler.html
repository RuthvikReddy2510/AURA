<div id="map" style="height: 600px; border-radius: 10px; overflow: hidden;"></div>

<script>
  const airportCoords = {{ airport_coords | tojson }};
  const map = L.map('map').setView([47.4502, -122.3088], 10); // Default to SEA

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

  // Hide Leaflet attribution (keep it if your license requires)
  const styleTag = document.createElement("style");
  styleTag.textContent = ".leaflet-control-attribution { display: none !important; }";
  document.head.appendChild(styleTag);

  const airplaneIcons = {
    "ALARM":   L.icon({ iconUrl: "/static/Alarm_Aeroplane.png",   iconSize: [32, 32] }),
    "ALERT":   L.icon({ iconUrl: "/static/Alert_Aeroplane.png",   iconSize: [32, 32] }),
    "WARNING": L.icon({ iconUrl: "/static/Warning_Aeroplane.png", iconSize: [32, 32] }),
    "NONE":    L.icon({ iconUrl: "/static/None_Aeroplane.png",    iconSize: [32, 32] })
  };

  let markers = [];

  function updateMap(airportCode) {
    const coords = airportCoords[airportCode];
    if (coords) map.setView([coords.lat, coords.lon], 10);

    fetch(`/api/planes?airport=${airportCode}&_=${Date.now()}`)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(planes => {
        // clear existing markers
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        planes.forEach(plane => {
          const level = (plane.AlertLevel || 'NONE').toUpperCase();
          const icon = airplaneIcons[level] || airplaneIcons['NONE'];
          const marker = L.marker([plane.Latitude, plane.Longitude], { icon }).addTo(map);

          const vel = Number(plane.Velocity || 0).toFixed(1);
          const heading = (plane.Heading ?? 'N/A');
          const status = plane.Status || 'Unknown';

          const popup = `
            <strong>${plane.Callsign || 'Unknown'}</strong><br>
            Altitude: ${plane.Altitude} m<br>
            Velocity: ${vel} m/s<br>
            Heading: ${heading}&deg;<br>
            Status: ${status}<br>
            <b>Caution Level:</b> ${plane.AlertLevel || 'NONE'}
          `;
          marker.bindPopup(popup);
          markers.push(marker);
        });

        renderConflictTable(planes);
      })
      .catch(err => {
        console.error('Failed to load planes:', err);
      });
  }

  const airportDropdown = document.getElementById("airport");
  airportDropdown.addEventListener("change", () => {
    const airportCode = airportDropdown.value.split(" - ")[0];
    updateMap(airportCode);
  });

  const defaultCode = airportDropdown.value.split(" - ")[0];
  updateMap(defaultCode);
</script>
